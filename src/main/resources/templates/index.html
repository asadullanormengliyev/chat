<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Chat App</title>
    <style>
        .container { display: flex; height: 100vh; border: 1px solid #ccc; border-radius: 10px; overflow: hidden; font-family: Arial, sans-serif; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        .chat-list { width: 30%; border-right: 1px solid #ddd; display: flex; flex-direction: column; background: #f7f7f7; }
        .chat-list-header { padding: 16px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #ddd; background: #eee; }
        .chat-list ul { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex: 1; }
        .chat-item { padding: 12px 16px; border-bottom: 1px solid #ddd; cursor: pointer; transition: background 0.2s; }
        .chat-item:hover { background: #e0e0e0; }
        .chat-item.active { background: #ccc; }
        .chat-name { font-weight: bold; color: #333; }
        .chat-last { font-size: 14px; color: #666; margin-top: 4px; }
        .chat-window { flex: 1; display: flex; flex-direction: column; background: #fff; }
        .chat-header { padding: 16px; font-weight: bold; font-size: 18px; border-bottom: 1px solid #ddd; background: #f2f2f2; color: #333; }
        .chat-messages { flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; background: #fff; }
        .message { max-width: 60%; padding: 10px 16px; border-radius: 20px; word-wrap: break-word; }
        .message.me { align-self: flex-end; background: #3b82f6; color: white; }
        .message.him { align-self: flex-start; background: #e5e5e5; color: #333; }
        .chat-input { display: flex; padding: 16px; border-top: 1px solid #ddd; background: #f2f2f2; }
        .chat-input input { flex: 1; padding: 10px 16px; border-radius: 25px; border: 1px solid #ccc; outline: none; margin-right: 8px; font-size: 14px; }
        .chat-input input:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.3); }
        .chat-input button { padding: 10px 20px; border-radius: 25px; background: #3b82f6; color: white; border: none; cursor: pointer; font-weight: bold; }
        .chat-input button:hover { background: #2563eb; }
    </style>
</head>
<body>
<div class="container">
    <!-- Chat list -->
    <div class="chat-list">
        <div class="chat-list-header">Chatlar</div>
        <ul id="chatList"></ul>
    </div>

    <!-- Chat window -->
    <div class="chat-window" id="chatWindow" style="display:none;">
        <div class="chat-header" id="chatHeader"></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
            <input id="messageInput" placeholder="Xabar yozing..." />
            <button id="sendBtn">Yuborish</button>
        </div>
    </div>
</div>

<!-- CDN Libraries -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/dist/stomp.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

<script>
    const token = localStorage.getItem("accessToken");
    let users = [];
    let activeChat = null;
    let chatInfo = null;
    let stompClient = null;

    const chatList = document.getElementById("chatList");
    const chatWindow = document.getElementById("chatWindow");
    const chatHeader = document.getElementById("chatHeader");
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    // Userlarni olish
    async function fetchUsers() {
        try {
            const res = await axios.get("/api/v1/users/get-all-users-by-username-search", {
                headers: { Authorization: `Bearer ${token}` }
            });
            users = res.data.content.map(u => ({ ...u, messages: [] }));
            renderChatList();
        } catch (err) {
            console.error("Users error:", err);
        }
    }

    // Chat list render
    function renderChatList() {
        chatList.innerHTML = "";
        users.forEach(user => {
            const li = document.createElement("li");
            li.className = "chat-item";
            li.innerHTML = `<div class="chat-name">${user.firstName}</div><div class="chat-last">${user.userName}</div>`;
            li.onclick = () => openChat(user, li);
            chatList.appendChild(li);
        });
    }

    // Chat ochish
    function openChat(user, li) {
        activeChat = user;
        document.querySelectorAll(".chat-item").forEach(item => item.classList.remove("active"));
        li.classList.add("active");

        chatWindow.style.display = "flex";
        chatHeader.textContent = user.firstName;
        renderMessages();
    }

    // Xabar yuborish
    function sendMessage() {
        if (!activeChat || !messageInput.value.trim() || !stompClient) return;

        const text = messageInput.value;
        activeChat.messages.push({ from: "me", text });
        renderMessages();

        stompClient.send(
            "/app/chat.sendMessage",
            { Authorization: `Bearer ${token}` },
            JSON.stringify({ chatId: activeChat.id, content: text })
        );

        messageInput.value = "";
    }

    // UI ga xabarlarni chizish
    function renderMessages() {
        chatMessages.innerHTML = "";
        activeChat.messages.forEach((msg) => {
            const div = document.createElement("div");
            div.className = `message ${msg.from}`;
            div.textContent = msg.text;
            chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // WebSocket ulash
    function connectWebSocket() {
        const socket = new SockJS("https://233f5eabced5.ngrok-free.app/chat");
        stompClient = Stomp.over(socket);

        // Debug logni o'chirish uchun:
        stompClient.debug = null;

        stompClient.connect(
            { Authorization: `Bearer ${token}` }, // headers
            function(frame) {
                console.log("WebSocket connected!", frame);

                // Serverdan xabar olish
                stompClient.subscribe("/user/queue/messages", function(msg) {
                    const message = JSON.parse(msg.body);
                    console.log("Kelgan:", message);

                    const chat = users.find(c => c.id === message.chatId);
                    if (chat) {
                        chat.messages.push({ from: "him", text: message.content });
                        if (activeChat && activeChat.id === chat.id) renderMessages();
                    }
                });
            },
            function(error) {
                console.error("WebSocket connection error:", error);
            }
        );
    }

    sendBtn.onclick = sendMessage;
    messageInput.addEventListener("keyup", (e) => { if (e.key === "Enter") sendMessage(); });

    // Boshlash
    fetchUsers();
    connectWebSocket();
</script>
</body>
</html>
